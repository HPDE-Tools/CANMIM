#include "adc_raw_conversion.h"
#include <algorithm>

static float PT385_100_0_300F_TABLE[301] = {
    93.0334, // Ohm at 0F
    93.2517,
    93.4699,
    93.6881,
    93.9063,
    94.1244,
    94.3425,
    94.5605,
    94.7786,
    94.9965,
    95.2145,
    95.4324,
    95.6503,
    95.8681,
    96.0859,
    96.3036,
    96.5214,
    96.7390,
    96.9567,
    97.1743,
    97.3919,
    97.6094,
    97.8269,
    98.0444,
    98.2618,
    98.4792,
    98.6966,
    98.9139,
    99.1312,
    99.3485,
    99.5657,
    99.7829,
    100,
    100.2171,
    100.4342,
    100.6512,
    100.8682,
    101.0852,
    101.3021,
    101.5190,
    101.7359,
    101.9527,
    102.1695,
    102.3862,
    102.6030,
    102.8196,
    103.0363,
    103.2529,
    103.4695,
    103.6860,
    103.9025,
    104.1190,
    104.3354,
    104.5518,
    104.7682,
    104.9845,
    105.2008,
    105.4171,
    105.6333,
    105.8495,
    106.0656,
    106.2817,
    106.4978,
    106.7138,
    106.9298,
    107.1458,
    107.3617,
    107.5776,
    107.7935,
    108.0093,
    108.2251,
    108.4409,
    108.6566,
    108.8723,
    109.0879,
    109.3035,
    109.5191,
    109.7347,
    109.9502,
    110.1656,
    110.3811,
    110.5965,
    110.8118,
    111.0272,
    111.2424,
    111.4577,
    111.6729,
    111.8881,
    112.1033,
    112.3184,
    112.5335,
    112.7485,
    112.9635,
    113.1785,
    113.3934,
    113.6083,
    113.8232,
    114.0380,
    114.2528,
    114.4675,
    114.6823,
    114.8970,
    115.1116,
    115.3262,
    115.5408,
    115.7553,
    115.9699,
    116.1843,
    116.3988,
    116.6132,
    116.8275,
    117.0419,
    117.2561,
    117.4704,
    117.6846,
    117.8988,
    118.1130,
    118.3271,
    118.5412,
    118.7552,
    118.9692,
    119.1832,
    119.3971,
    119.6110,
    119.8249,
    120.0387,
    120.2525,
    120.4663,
    120.6800,
    120.8937,
    121.1073,
    121.3210,
    121.5345,
    121.7481,
    121.9616,
    122.1751,
    122.3885,
    122.6019,
    122.8153,
    123.0286,
    123.2419,
    123.4552,
    123.6684,
    123.8816,
    124.0947,
    124.3078,
    124.5209,
    124.7340,
    124.9470,
    125.1600,
    125.3729,
    125.5858,
    125.7987,
    126.0115,
    126.2243,
    126.4371,
    126.6498,
    126.8625,
    127.0751,
    127.2877,
    127.5003,
    127.7129,
    127.9254,
    128.1379,
    128.3503,
    128.5627,
    128.7751,
    128.9874,
    129.1997,
    129.4120,
    129.6242,
    129.8364,
    130.0485,
    130.2607,
    130.4727,
    130.6848,
    130.8968,
    131.1088,
    131.3207,
    131.5326,
    131.7445,
    131.9563,
    132.1681,
    132.3799,
    132.5916,
    132.8033,
    133.0150,
    133.2266,
    133.4382,
    133.6497,
    133.8612,
    134.0727,
    134.2841,
    134.4956,
    134.7069,
    134.9183,
    135.1296,
    135.3408,
    135.5521,
    135.7632,
    135.9744,
    136.1855,
    136.3966,
    136.6077,
    136.8187,
    137.0296,
    137.2406,
    137.4515,
    137.6624,
    137.8732,
    138.0840,
    138.2948,
    138.5055,
    138.7162,
    138.9269,
    139.1375,
    139.3481,
    139.5586,
    139.7691,
    139.9796,
    140.1900,
    140.4005,
    140.6108,
    140.8212,
    141.0315,
    141.2417,
    141.4520,
    141.6622,
    141.8723,
    142.0824,
    142.2925,
    142.5026,
    142.7126,
    142.9226,
    143.1325,
    143.3424,
    143.5523,
    143.7621,
    143.9719,
    144.1817,
    144.3914,
    144.6011,
    144.8108,
    145.0204,
    145.2300,
    145.4396,
    145.6491,
    145.8586,
    146.0680,
    146.2774,
    146.4868,
    146.6961,
    146.9054,
    147.1147,
    147.3239,
    147.5331,
    147.7423,
    147.9514,
    148.1605,
    148.3695,
    148.5786,
    148.7875,
    148.9965,
    149.2054,
    149.4143,
    149.6231,
    149.8319,
    150.0407,
    150.2494,
    150.4581,
    150.6668,
    150.8754,
    151.0840,
    151.2926,
    151.5011,
    151.7096,
    151.9180,
    152.1264,
    152.3348,
    152.5431,
    152.7514,
    152.9597,
    153.1679,
    153.3761,
    153.5843,
    153.7924,
    154.0005,
    154.2086,
    154.4166,
    154.6246,
    154.8325,
    155.0404,
    155.2483,
    155.4562,
    155.6640,
    155.8717,
    156.0795,
    156.2872,
    156.4948,
    156.7025,
    156.9100, // Ohm at 300F
};

namespace hpde_tools
{

static int PT385_RtoTemp(float r) {
    float* result = std::lower_bound(PT385_100_0_300F_TABLE, PT385_100_0_300F_TABLE+sizeof(PT385_100_0_300F_TABLE)/sizeof(float), r);
    return (result - PT385_100_0_300F_TABLE);
}

void ADCConversionPT385_100Temp_WithR(uint16_t *temp, uint16_t huv, float r) {
    uint16_t r_huv =  50000 - huv;
    float pt385_r = r / r_huv * huv;
    *temp = (uint16_t) PT385_RtoTemp(pt385_r);
}

void ADCConversionPT385_100Temp(uint16_t *temp, uint16_t huv) {
    ADCConversionPT385_100Temp_WithR(temp, huv, 100.0);
}


}